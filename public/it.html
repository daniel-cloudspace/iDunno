<script type="text/javascript" src="/socket.io/socket.io.js"></script>
<script type="text/javascript" src="keys.js"></script>
<script type="text/javascript">
function $(id) {
    return document.getElementById(id);
}
</script>

<body style="background-image:url('/background.png');">
	<div id="cloudmap" style="position: absolute; left:0; top:0; height:2427; width:2131;">
	</div>
</body>





<script type="text/javascript">

window.addEventListener('load', function()
{

	// Window environment data
	var window_width = window.innerWidth;
	var window_height = window.innerHeight;
	// Events to update that data
	document.addEventListener('resize', function(e) {
		window_width = window.innerWidth;
		window_height = window.innerHeight;
	}, false);


	// Key stroke bindings
	var keys = {};
	document.addEventListener('keydown', function(e) {
		keys[e.keyCode] = true;
		e.preventDefault(); // prevents scrolling
	}, false);
	document.addEventListener('keyup', function(e) {
		keys[e.keyCode] = false;
		e.preventDefault(); // prevents scrolling
	}, false);
	document.addEventListener('keypress', function(e) {
		e.preventDefault(); // prevents scrolling
	}, false);





	function create_new_player(id) {
		var playerSpriteHTML = "<div id='guy" + id + "' style=\"position: absolute; background-image:url('http://blogoscoped.com/files/last-guardian-sprites.png'); background-position: 507px 68px; width:70px; height:70px;\">&nbsp;</div>";
		$('cloudmap').innerHTML += playerSpriteHTML;
		return { sprite: $('guy' + id), x: 0, y: 0 };
	}


	var players = {};
	var player = {x:0, y:0};
 
	var socket = new io.Socket(null, {port: 8080, rememberTransport: false});
	socket.connect();
	socket.on('connect', function(){ console.log('connected'); })
	socket.on('message', function(message) {
		for (var i in message) {
			if (typeof players[i] == "undefined") { players[i] = create_new_player(i); }

			players[i].x = message[i].x;
			players[i].y = message[i].y;
		}
	});

	socket.on('disconnect', function(){ console.log('disconnected'); })




	// Update the Server with your coordinates
	window.setInterval(function() {
		socket.send({x: player.x, y: player.y});
	}, 50);
	
	// Game Loop
	window.setInterval(function() {
		// process input
		if (keys[DOM_VK.LEFT]) { player.x -= 5; }
		if (keys[DOM_VK.RIGHT]) { player.x += 5; }
		if (keys[DOM_VK.UP]) { player.y -= 5; }
		if (keys[DOM_VK.DOWN]) { player.y += 5; }
		
		// draw
		for (i in players) {
			players[i].sprite.style.marginLeft = players[i].x + 'px';
			players[i].sprite.style.marginTop = players[i].y + 'px';
		}

		// make player the center of the screen
		if ( player.y > window_height / 2.0 ) {
			document.body.scrollTop = player.y - window_height / 2.0;
		}
		if ( player.x > window_width / 2.0 ) {
			document.body.scrollLeft = player.x - window_width / 2.0;
		}
	}, 20);

}, false);

</script>


